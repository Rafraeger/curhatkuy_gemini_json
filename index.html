<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Chatbot SIMPEL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css?v=4" />
</head>
<body>

<button class="ck-launcher" id="ck-launcher" aria-label="Buka Chatbot">
  <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M20 2H4a2 2 0 0 0-2 2v14l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z" fill="currentColor"/>
  </svg>
</button>

<div class="ck-chat" id="ck-chat" role="dialog" aria-modal="false" aria-labelledby="ck-title">
  <div class="ck-header">
    <div class="ck-title" id="ck-title">Chatbot SIMPEL</div>
    <div class="ck-right">
      <div class="ck-badge" id="ck-badge">Sisa: …</div>
      <button class="ck-close" id="ck-close" aria-label="Tutup">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path d="M18 6L6 18M6 6l12 12" stroke="#fff" stroke-width="2" fill="none"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="ck-body">
    <div class="ck-box" id="ck-box"></div>

    <div class="ck-actions" id="ck-actions">
      <button id="ck-admin" class="ck-btn sm hidden">Hubungi Admin</button>
      <button id="ck-new"   class="ck-btn sm hidden">Mulai Sesi Baru</button>
    </div>

    <div class="ck-input">
      <input id="ck-input" type="text" placeholder="Tulis pesan..." autocomplete="off" />
      <button id="ck-send" class="ck-btn primary">Kirim</button>
    </div>
  </div>
</div>

<script>
  const API = "http://127.0.0.1:8000";         // DEV
  const ADMIN_URL = "https://wa.me/62xxxxxxxxxx";

  const launcher = document.getElementById("ck-launcher");
  const chat     = document.getElementById("ck-chat");
  const closeBtn = document.getElementById("ck-close");
  const box      = document.getElementById("ck-box");
  const input    = document.getElementById("ck-input");
  const sendBtn  = document.getElementById("ck-send");
  const actions  = document.getElementById("ck-actions");
  const btnAdmin = document.getElementById("ck-admin");
  const btnNew   = document.getElementById("ck-new");
  const badge    = document.getElementById("ck-badge");

  const SID_KEY = "ck_session_id";
  let sessionId = localStorage.getItem(SID_KEY);
  if (!sessionId) {
    sessionId = (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random().toString(16).slice(2)));
    localStorage.setItem(SID_KEY, sessionId);
  }

  // state status dari backend
  let sessionState = { end: false, remaining: 5 };

  function escapeHtml(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
  function linkify(s){return s.replace(/https?:\/\/[^\s)]+/g,m=>`<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);}
  function mdToHtmlSafe(md){
    md = (md||"").trim();
    md = escapeHtml(md);
    md = md.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>').replace(/^##\s+(.*)$/gm,'<h3>$1</h3>').replace(/^#\s+(.*)$/gm,'<h3>$1</h3>');
    md = md.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>');
    md = md.replace(/(^|\n)(\d+)\.\s+([^\n]+)/g,'$1<li>$3</li>').replace(/(?:<li>[\s\S]*?<\/li>)/gms, m=>`<ol>${m.replace(/<\/li>\s*<li>/g,'</li><li>')}</ol>`);
    md = md.replace(/(^|\n)[\-\*\u2022]\s+([^\n]+)/g,'$1<li>$2</li>').replace(/(?:<li>[\s\S]*?<\/li>)/gms, m=> /<ol>/.test(m)?m:`<ul>${m.replace(/<\/li>\s*<li>/g,'</li><li>')}</ul>`);
    md = md.split(/\n{2,}/).map(b=> /^<h3>|^<ul>|^<ol>/.test(b)? b : `<p>${b.replace(/\n/g,'<br>')}</p>`).join("");
    return linkify(md);
  }

  function inlineFormat(t){
  t = escapeHtml(t);
  t = t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  t = t.replace(/\*(.+?)\*/g,'<em>$1</em>');
  t = linkify(t);
  return t;
  }
  
  function appendMsg(text, who="bot"){
    const el = document.createElement("div");
    el.className = "ck-msg " + who;
    el.innerHTML = (who==="bot") ? mdToHtmlSafe(text) : escapeHtml(text);
    box.appendChild(el);
    box.scrollTop = box.scrollHeight;
  }

  function setRemaining(n){
    const c = Math.max(0, Math.min(5, Number(n||0)));
    badge.textContent = `Sisa: ${c}/5`;
  }

  function endUI(){
    input.disabled = true; sendBtn.disabled = true;
    actions.classList.add("show");
    btnNew.classList.remove("hidden");
  }

  function welcome(){
    if (box.dataset.hasWelcome === "1") return;
    appendMsg(
`### Hai! 👋
Aku asisten CurhatKuy. Aku fokus pada **psikologi** & **FAQ** (jam, lokasi, layanan, tarif, booking).
Kondisi darurat? Hubungi **112/119**.

- Maksimal **5 pesan** per sesi
- Bahas seperlunya, jaga privasi ya 😊`, "bot");
    box.dataset.hasWelcome = "1";
  }

  function openChat(){
    chat.classList.add("open");
    // Tampilkan sambutan hanya jika belum ada pesan & sesi belum end
    if (box.childElementCount === 0 && box.dataset.hasWelcome !== "1" && !sessionState.end) {
      welcome();
    }
    input.focus();
  }
  function closeChat(){ chat.classList.remove("open"); }

  async function fetchStatus(){
    try{
      const res = await fetch(`${API}/status`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ session_id: sessionId })
      });
      let data;
      try { data = await res.json(); }
      catch { let raw = await res.text(); data = JSON.parse(raw.replace(/^\uFEFF/,"").trim()); }

      sessionState.end = !!data.end;
      sessionState.remaining = typeof data.remaining === "number" ? data.remaining : 5;
      setRemaining(sessionState.remaining);

      if (sessionState.end) {
        // tampilkan end-state segera (bahkan sebelum mengirim pesan)
        endUI();
      } else {
        // pastikan input aktif jika belum end
        input.disabled = false; sendBtn.disabled = false;
        actions.classList.remove("show");
        btnNew.classList.add("hidden");
      }
    }catch(e){
      // bila status gagal diambil, tampilkan default 5/5 tapi input tetap aktif
      setRemaining(5);
    }
  }

  async function send(){
    const msg = input.value.trim();
    if (!msg) return;
    appendMsg(msg, "user");
    input.value = "";

    try{
      const res = await fetch(`${API}/chat`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: msg, session_id: sessionId })
      });
      let data;
      try { data = await res.json(); }
      catch { let raw = await res.text(); data = JSON.parse(raw.replace(/^\uFEFF/,"").trim()); }

      if (typeof data.reply === "string") appendMsg(data.reply, "bot");
      if (typeof data.remaining !== "undefined") setRemaining(data.remaining);
      if (data.handoff) { actions.classList.add("show"); btnAdmin.classList.remove("hidden"); }
      if (data.end) endUI();

    }catch(e){
      appendMsg(`❌ Gagal menghubungi server: ${e?.message||e}`, "bot");
    }
  }

  launcher.addEventListener("click", openChat);
  closeBtn.addEventListener("click", closeChat);
  sendBtn.addEventListener("click", send);
  input.addEventListener("keydown", e => { if(e.key==="Enter") send(); });
  btnAdmin.addEventListener("click", () => window.open(ADMIN_URL, "_blank"));
  btnNew.addEventListener("click", async () => {
    localStorage.removeItem(SID_KEY);
    sessionId = (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random().toString(16).slice(2)));
    localStorage.setItem(SID_KEY, sessionId);

    // reset UI
    box.innerHTML = "";
    delete box.dataset.hasWelcome;
    actions.classList.remove("show");
    btnAdmin.classList.add("hidden");
    btnNew.classList.add("hidden");
    input.disabled = false; sendBtn.disabled = false;
    input.placeholder = "Tulis pesan...";

    await fetchStatus();   // sinkron status sesi baru (should be 5/5, not default)
    openChat();            // welcome akan muncul otomatis bila box kosong & belum end
  });

  // ==== sinkron status saat halaman dimuat ====
  fetchStatus();
</script>

</body>
</html>
